flowchart TD
    subgraph Core ["Core Module"]
        direction TB
        signal_data[SignalData]
        signal_collection[SignalCollection]
        subgraph Metadata ["Metadata Classes"]
            ts_metadata[TimeSeriesMetadata]
            feature_metadata[FeatureMetadata]
            collection_metadata[CollectionMetadata]
            operation_info[OperationInfo]
        end
        metadata_handler[MetadataHandler]

        subgraph Repositories ["Repository Layer"]
            signal_repository[SignalRepository]
        end

        subgraph Services ["Service Layer"]
            signal_query_service[SignalQueryService]
            metadata_manager[MetadataManager]
            alignment_grid_service[AlignmentGridService]
            epoch_grid_service[EpochGridService]
            alignment_executor[AlignmentExecutor]
            signal_combination_service[SignalCombinationService]
            operation_executor[OperationExecutor]
            data_import_service[DataImportService]
            signal_summary_reporter[SignalSummaryReporter]
        end

        subgraph Models ["State Models"]
            alignment_state[AlignmentGridState]
            epoch_state[EpochGridState]
            combination_result[CombinationResult]
        end
    end

    subgraph Signal_Types ["Signal Types"]
        direction TB
        signal_type[SignalType]
        feature_type[FeatureType]
        sensor_type[SensorType]
        sensor_model[SensorModel]
        body_position[BodyPosition]
        unit[Unit]
    end

    subgraph Signals ["TimeSeries Signal Classes"]
        direction TB
        time_series[TimeSeriesSignal]
        ppg[PPGSignal]
        acc[AccelerometerSignal]
        hr[HeartRateSignal]
        eeg_stage[EEGSleepStageSignal]
        magnitude[MagnitudeSignal]
        angle[AngleSignal]
    end

    subgraph Features ["Feature Classes"]
        direction TB
        feature_class[Feature]
        statistical_features[Statistical Features]
        categorical_mode[Categorical Mode Features]
    end

    subgraph Operations ["Operations Module"]
        direction TB
        feature_extraction[Feature Extraction]
        compute_stats[compute_feature_statistics]
        compute_stage_mode[compute_sleep_stage_mode]
        signal_alignment[Signal Alignment Operations]
    end

    subgraph Importers ["Importer Classes"]
        direction TB
        importer_base[SignalImporter]
        csv_importer[CSVImporterBase]
        polar[PolarCSVImporter]
        enchanted_wave[EnchantedWaveImporter]
        merging[MergingImporter]
    end

    subgraph Export ["Export Module"]
        direction TB
        export_module[ExportModule]
    end

    subgraph Visualization ["Visualization Module"]
        direction TB
        vis_base[VisualizerBase]
        bokeh_vis[BokehVisualizer]
        plotly_vis[PlotlyVisualizer]
        
        subgraph Plotting_Functions ["Plotting Functions"]
            create_ts_plot[create_time_series_plot]
            create_hypnogram[create_hypnogram_plot]
            vis_collection[visualize_collection]
            vis_signal[visualize_signal]
            vis_hypnogram[visualize_hypnogram]
            add_regions[add_categorical_regions]
        end
    end

    subgraph Workflows ["Workflow Engine"]
        direction TB
        workflow_executor[WorkflowExecutor]
    end

    subgraph CLI ["Command Line"]
        direction TB
        run_workflow[run_workflow.py]
    end

    subgraph Algorithms ["ML Algorithms"]
        direction TB
        algorithm_base[SleepStagingAlgorithm]
        random_forest[RandomForestSleepStaging]
        evaluation[Evaluation Module]
    end

    subgraph Utils ["Utilities"]
        direction TB
        logging[Logging]
        data_utils[Data Utils]
    end

    %% Class Inheritance
    signal_data --> time_series
    time_series --> ppg
    time_series --> acc
    time_series --> hr
    time_series --> eeg_stage
    time_series --> magnitude
    time_series --> angle
    
    vis_base --> bokeh_vis
    vis_base --> plotly_vis
    
    importer_base --> csv_importer
    csv_importer --> polar
    csv_importer --> enchanted_wave
    importer_base --> merging
    
    feature_extraction --> compute_stats
    feature_extraction --> compute_stage_mode
    compute_stats --> statistical_features
    compute_stage_mode --> categorical_mode

    %% Algorithm inheritance
    algorithm_base --> random_forest

    %% Visualization methods
    vis_base --> Plotting_Functions

    %% Main data flow and dependencies
    CLI --> Workflows

    Workflows --> Importers
    Workflows --> Core
    Workflows --> Operations
    Workflows --> Export
    Workflows --> Visualization
    Workflows --> Algorithms

    Importers --> Core
    Importers --> Signals

    %% SignalCollection uses Services and Repository
    signal_collection --> Repositories
    signal_collection --> Services
    signal_collection --> Models

    %% Services use Repositories and Models
    Services --> Repositories
    Services --> Models
    Services --> Metadata

    %% Collection uses operations
    Core --> Signals
    Core --> Features
    Core --> Export
    Core --> Operations
    %% Collection uses visualization
    Core --> Visualization

    %% Signals use Metadata
    Signals --> Core
    %% Features use Metadata
    Features --> Core

    %% Operations use Collection/Metadata
    Operations --> Core
    %% Operations process Signals
    Operations --> Signals
    %% Operations produce Features
    Operations --> Features

    %% Algorithms use Operations and Features
    Algorithms --> Operations
    Algorithms --> Features
    Algorithms --> Core

    %% Export uses Collection/Metadata
    Export --> Core

    %% Visualization uses Collection/Metadata
    Visualization --> Core
    %% Visualization plots Signals
    Visualization --> Signals
    %% Visualization plots Features
    Visualization --> Features

    Signal_Types -.-> Core
    Signal_Types -.-> Signals
    Signal_Types -.-> Features
    Signal_Types -.-> Importers
    Signal_Types -.-> Operations
    Signal_Types -.-> Algorithms

    Utils -.-> Core
    Utils -.-> Importers
    Utils -.-> Workflows
    Utils -.-> Export
    Utils -.-> Operations
    Utils -.-> Visualization
    Utils -.-> Algorithms
