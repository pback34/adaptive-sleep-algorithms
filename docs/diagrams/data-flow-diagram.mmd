flowchart TB
    %% Input Sources and Importer
    ImportSource[/"Signal Source Files\nCSV, Polar, etc."/] --> Importer{{"Importer\nPolarCSVImporter, etc."}}
    Importer --> |"create TimeSeriesSignal"| TSSignals["TimeSeriesSignals\n(hr_0, accel_0, etc.)"]
    TSSignals --> |"stored in"| Collection["SignalCollection\ntime_series_signals : Dict[str, TimeSeriesSignal]"]
    
    %% Workflow Operations - Alignment
    Collection --> |"step: generate_alignment_grid"| AlignmentGridService["AlignmentGridService\nCalculate grid parameters"]
    AlignmentGridService --> |"sets"| GridIndex["grid_index : pd.DatetimeIndex\n_alignment_params_calculated = True\nAlignmentGridState created"]
    GridIndex --> |"optional step: apply_grid_alignment"| AlignmentExecutor["AlignmentExecutor\nAlign TimeSeriesSignals to grid"]
    AlignmentExecutor --> |"applies alignment"| AlignSignals["Aligned TimeSeriesSignals\nin Repository"]
    
    %% Feature Grid Creation
    Collection --> |"step: generate_epoch_grid"| EpochGridService["EpochGridService\nCalculate epoch grid"]
    WorkflowConfig["Workflow YAML\nepoch_grid_config:\n  window_length: '30s'\n  step_size: '10s'"] --> |"configures"| EpochGridService
    EpochGridService --> |"sets"| EpochParams["epoch_grid_index : pd.DatetimeIndex\nglobal_epoch_window_length : Timedelta\nglobal_epoch_step_size : Timedelta\nEpochGridState created"]
    
    %% Feature Extraction Process
    TSSignals --> |"input to"| OperationExecutor["OperationExecutor\nDispatch multi-signal operations"]

    OperationExecutor --> |"type: feature_statistics"| StatFeatures["Statistical Features\nMean, std, min, max, etc.\nFeatureType.STATISTICAL"]
    OperationExecutor --> |"type: compute_sleep_stage_mode"| StageModeFeatures["Sleep Stage Mode\nModal sleep stage per epoch\nFeatureType.CATEGORICAL_MODE"]

    EpochParams --> |"provides epoch grid"| OperationExecutor
    OperationExecutor --> |"uses epoch state"| EpochParams
    
    StatFeatures --> |"for each epoch start time"| ProcessEpochStat["Process Epoch Data\n1. Slice signal data for epoch\n2. Calculate statistics\n3. Store results with MultiIndex"]
    StageModeFeatures --> |"for each epoch start time"| ProcessEpochMode["Process Epoch Data\n1. Slice signal data for epoch\n2. Calculate most frequent stage\n3. Store results with feature='sleep_stage_mode'"]
    
    ProcessEpochStat --> |"creates"| Features["Feature Objects\nmetadata: FeatureMetadata\ndata: DataFrame[epochs Ã— features]"]
    ProcessEpochMode --> |"creates"| Features
    
    Features --> |"stored in"| SignalRepository["SignalRepository\nfeatures : Dict[str, Feature]"]

    %% Feature Combination
    SignalRepository --> |"step: combine_features"| SignalCombinationService["SignalCombinationService\n1. Validate epoch alignment\n2. Concatenate feature columns\n3. Build MultiIndex columns"]
    WorkflowConfig --> |"configures"| FeatureIndexConfig["feature_index_config: List[str]\n['name', 'feature_type', 'sensor_model']"]
    FeatureIndexConfig --> |"provides column structure"| SignalCombinationService
    SignalCombinationService --> |"creates"| CombinedMatrix["CombinationResult\n_combined_feature_matrix\nDataFrame with MultiIndex columns"]
    
    %% Export 
    Collection --> |"export section"| Export["ExportModule\n1. Export TimeSeriesSignals\n2. Export Features\n3. Export CombinedMatrix"]
    Export --> |"generates"| OutputFiles[/"Output Files\nCSV, Excel, etc."/]
    
    %% Visualization Flow
    Collection --> |"visualization section"| Visualizer["Visualization\nBokehVisualizer/PlotlyVisualizer"]
    TSSignals --> |"visualize_signal"| Visualizer
    Features --> |"visualize_signal"| Visualizer
    
    %% Sleep Stage Overlay
    EEGStageSignal["EEGSleepStageSignal\n(sleep stage data)"] --> |"overlay_sleep_stages"| BackgroundOverlay["Sleep Stage Background\nColored regions by stage"]
    BackgroundOverlay --> |"added to"| Visualizer
    
    Visualizer --> |"produces"| VisOutput[/"Visualization Output\nHTML, PNG, etc."/]
    
    subgraph "Input Processing"
        ImportSource
        Importer
        TSSignals
    end
    
    subgraph "Alignment & Epoch Grid Services"
        AlignmentGridService
        GridIndex
        AlignmentExecutor
        AlignSignals
        EpochGridService
        EpochParams
        WorkflowConfig
    end
    
    subgraph "Feature Generation"
        OperationExecutor
        StatFeatures
        StageModeFeatures
        ProcessEpochStat
        ProcessEpochMode
        Features
    end
    
    subgraph "Feature Combination Service"
        SignalCombinationService
        FeatureIndexConfig
        CombinedMatrix
        SignalRepository
    end
    
    subgraph "Output Generation"
        Export
        OutputFiles
        Visualizer
        VisOutput
        BackgroundOverlay
    end
    
    %% Data Transformation Flow
    subgraph "TimeSeriesSignal Data Structure"
        TimeSeriesData["Raw Data: pd.DataFrame\nwith DatetimeIndex of raw timestamps\nColumns: signal-specific values"] 
        --> |"apply_grid_alignment"| AlignedData["Aligned Data: pd.DataFrame\nwith DatetimeIndex matching grid_index\nData reindexed to common timepoints"]
        TimeSeriesData --> |"align_and_combine_signals"| CombinedSignals["Combined Time-Series: pd.DataFrame\nwith DatetimeIndex matching grid_index\nColumns: combined from all signals"]
    end
    
    subgraph "Feature Data Structure"
        FeatureData["Statistical Feature Data: pd.DataFrame\nwith DatetimeIndex of epoch start times\nColumns: (signal_key, feature) MultiIndex\ne.g., (hr_0, mean), (hr_0, std)"] 
        
        CategoryData["Categorical Feature Data: pd.DataFrame\nwith DatetimeIndex of epoch start times\nColumns: (signal_key, feature) MultiIndex\ne.g., (eeg_0, sleep_stage_mode)"]
        
        FeatureData --> |"combine_features"| CombinedFeatureData["Combined Feature Matrix: pd.DataFrame\nwith DatetimeIndex of epoch start times\nColumns: (feature_set, signal_key, feature) MultiIndex\ne.g., (hr_stats, hr_0, mean), (sleep_stages, eeg_0, sleep_stage_mode)"]
        
        CategoryData --> |"combine_features"| CombinedFeatureData
    end
    
    TimeSeriesData --> |"compute_feature_statistics"| FeatureData
    TimeSeriesData --> |"compute_sleep_stage_mode"| CategoryData
