# Polar Workflow Example with relative paths and file patterns
# This workflow demonstrates importing heart rate and accelerometer data 
# from Polar H10 and Sense sensors, and exporting to CSV
#
# To run:
# python -m sleep_analysis.cli.run_workflow --workflow workflows/polar_workflow.yaml --data-dir data

import:
  # Heart Rate data from Polar H10 - using MergingImporter
  - signal_type: "heart_rate"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_H10_*_HR.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        hr: "HR [bpm]"
        hrv: "HRV [ms]"
        hrv: "HRV [ms]"
    sensor_type: "EKG"
    sensor_model: "PolarH10"
    body_position: "chest"
    name: "H10_HR"
    base_name: "hr"


  # Accelerometer data from Polar H10 - using MergingImporter
  - signal_type: "accelerometer"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_H10_*_ACC.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        x: "X [mg]"
        y: "Y [mg]"
        z: "Z [mg]"
    sensor_type: "ACCEL"
    sensor_model: "PolarH10"
    body_position: "chest"
    name: "H10_ACC"
    base_name: "accel"
    

  # Heart Rate data from Polar Sense - using MergingImporter
  - signal_type: "heart_rate"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_Sense_*_HR.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        hr: "HR [bpm]"
    sensor_type: "EKG"
    sensor_model: "PolarSense"
    body_position: "left_wrist"
    name: "Sense_HR"
    base_name: "hr"
    


  # Accelerometer data from Polar Sense - using MergingImporter
  - signal_type: "accelerometer"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_Sense_*_ACC.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        x: "X [mg]"
        y: "Y [mg]"
        z: "Z [mg]"
    sensor_type: "ACCEL"
    sensor_model: "PolarSense"
    body_position: "left_wrist"
    name: "Sense_ACC"
    base_name: "accel"
    


# Process steps to compute magnitude signals and align everything
steps:
  # Generate magnitude signals from all accelerometer signals
  - type: signal
    input: "accel"  # Base name for all accelerometer signals
    operation: "compute_magnitude"
    output: "accel_magnitude"
    
  # Generate angle signals from all accelerometer signals
  - type: signal
    input: "accel"  # Base name for all accelerometer signals
    operation: "compute_angle"
    output: "accel_angle"
    
  # Align signals to the same time grid
  - type: collection
    operation: "align_signals"
    parameters:
      target_sample_rate: 50.0  # Hz - force all signals to a clean factor of 1000
      method: "nearest"
      preserve_original: true
      inplace: true
      resample_strategy: "nearest"  # Options: "downsample", "upsample", "nearest"

# Export section - defines the output formats and location
export:
  formats: ["csv"]
  output_dir: "results/polar_data"
  include_combined: true
  index_config: ["signal_type", "sensor_model", "body_position", "name"]

# Visualization section - creates plots of selected signals
visualization:
  # Create a time series plot of heart rate signals from both devices
  - type: time_series
    signals: ["hr"]  # All heart rate signals
    layout: vertical
    title: "Heart Rate Comparison: All Devices"
    output: "results/visualizations/heart_rate_comparison.html"
    backend: plotly
    parameters:
      # width: 3000
      # height: 800
      x_label: "Time"
      y_label: "Heart Rate (bpm)"
      strict: false  # Skip missing signals with warning
      colorscale: "Plotly"  # Use Plotly's default qualitative colorscale

  # Plot accelerometer magnitude signals
  - type: time_series
    signals: ["accel_magnitude"]  # All accelerometer magnitude signals
    title: "Accelerometer Magnitude Signals"
    output: "results/visualizations/accel_magnitude.html"
    backend: bokeh
    parameters:
      # width: 1200
      # height: 800
      line_color: "blue"
      x_label: "Time"
      y_label: "Magnitude (mg)"
      strict: false

  # Create a grid layout with multiple signal types
  - type: time_series
    signals: ["hr", "accel_magnitude", "accel_angle"]  # First of each type
    layout: grid
    title: "Multivariate Signal Dashboard"
    output: "results/visualizations/multivariate_dashboard.html"
    backend: plotly
    parameters:
      # width: 3000 
      # height: 600
      link_x_axes: true  # Synchronize x-axes for time alignment
      strict: false
      
  # Create a comprehensive plot with all signals in separate subplots
  - type: time_series
    signals: ["hr", "accel_magnitude", "accel_angle"]  # All signals of these types
    layout: vertical
    title: "All Signals Overview with Linked X-Axes"
    output: "results/visualizations/all_signals_overview.html"
    backend: plotly
    parameters:
      link_x_axes: true  # Ensure x-axes are linked across all subplots
      # width: 1200
      # height: 1800  # Taller to accommodate all subplots
      strict: false
