# Polar Workflow Example with relative paths and file patterns
# This workflow demonstrates importing heart rate and accelerometer data 
# from Polar H10 and Sense sensors, and exporting to CSV
#
# To run:
# python -m sleep_analysis.cli.run_workflow --workflow workflows/polar_workflow.yaml --data-dir data

# Timezone settings
default_input_timezone: "America/New_York" # Assume source files are EST unless overridden
target_timezone: "system" # Standardize all timestamps to the system's local timezone

import:
  # Heart Rate data from Polar H10 - using MergingImporter
  - signal_type: "heart_rate"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_H10_*_HR.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        hr: "HR [bpm]"
        hrv: "HRV [ms]"
        hrv: "HRV [ms]"
    sensor_type: "EKG"
    sensor_model: "PolarH10"
    body_position: "chest"
    name: "H10_HR"
    base_name: "hr"


  # Accelerometer data from Polar H10 - using MergingImporter
  - signal_type: "accelerometer"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_H10_*_ACC.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        x: "X [mg]"
        y: "Y [mg]"
        z: "Z [mg]"
    sensor_type: "ACCEL"
    sensor_model: "PolarH10"
    body_position: "chest"
    name: "H10_ACC"
    base_name: "accel"
    

  # Heart Rate data from Polar Sense - using MergingImporter
  - signal_type: "heart_rate"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_Sense_*_HR.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        hr: "HR [bpm]"
    sensor_type: "EKG"
    sensor_model: "PolarSense"
    body_position: "left_wrist"
    name: "Sense_HR"
    base_name: "hr"
    


  # Accelerometer data from Polar Sense - using MergingImporter
  - signal_type: "accelerometer"
    importer: "MergingImporter"
    source: "."
    config:
      file_pattern: "Polar_Sense_*_ACC.txt"
      timestamp_col: "Phone timestamp"
      sort_by: "timestamp"
      delimiter: ";"
      column_mapping:
        timestamp: "Phone timestamp"
        x: "X [mg]"
        y: "Y [mg]"
        z: "Z [mg]"
    sensor_type: "ACCEL"
    sensor_model: "PolarSense"
    body_position: "left_wrist"
    name: "Sense_ACC"
    base_name: "accel"


  # EEG Sleep Stage data from Enchanted Wave - using MergingImporter
  - signal_type: "eeg_sleep_stage"
    importer: "MergingImporter" # Use MergingImporter to handle potential multiple files
    source: "."
    config:
      # Configuration for the underlying importer (EnchantedWaveImporter)
      importer_name: "EnchantedWaveImporter"
      file_pattern: "*.Session.csv" # Pattern to find Enchanted Wave files
      # EnchantedWaveImporter uses default column mapping, no need to specify here unless overriding
      # Override the default_input_timezone for this specific source
      origin_timezone: "UTC" # Assume this specific source file is in UTC
    sensor_type: "EEG"
    sensor_model: "EnchantedWave"
    body_position: "head"
    name: "EnchantedWave_SleepStage"
    base_name: "sleep_stage"


# Process steps to compute magnitude signals and align everything
steps:
  # Generate magnitude signals from all accelerometer signals
  - type: signal
    input: "accel"  # Base name for all accelerometer signals
    operation: "compute_magnitude"
    output: "accel_magnitude"
    
  # Generate angle signals from all accelerometer signals
  - type: signal
    input: "accel"  # Base name for all accelerometer signals
    operation: "compute_angle"
    output: "accel_angle"
    
  # Align signals to the same time grid
  # Align signals - calculates alignment parameters (target_rate, ref_time, grid_index)
  # The actual alignment happens during get_combined_dataframe or export.
  - type: collection
    operation: "align_signals"
    parameters:
      target_sample_rate: 50.0  # Optional: Specify target rate (Hz). If omitted, uses max standard rate <= highest signal rate.

# Export section - defines the output formats and location
export:
  formats: ["csv"]
  output_dir: "results/polar_data"
  include_combined: true
  index_config: ["signal_type", "sensor_model", "body_position", "name"]

# Visualization section - creates plots of selected signals
visualization:
  # Create a time series plot of heart rate signals from both devices
  - type: time_series
    signals: ["hr"]  # All heart rate signals
    layout: vertical
    title: "Heart Rate Comparison: All Devices"
    output: "results/visualizations/heart_rate_comparison.html"
    backend: plotly
    parameters:
      # width: 3000
      # height: 800
      x_label: "Time"
      y_label: "Heart Rate (bpm)"
      strict: false  # Skip missing signals with warning
      colorscale: "Plotly"  # Use Plotly's default qualitative colorscale

  # Plot accelerometer magnitude signals
  - type: time_series
    signals: ["accel_magnitude"]  # All accelerometer magnitude signals
    title: "Accelerometer Magnitude Signals"
    output: "results/visualizations/accel_magnitude.html"
    backend: bokeh
    parameters:
      # width: 1200
      # height: 800
      line_color: "blue"
      x_label: "Time"
      y_label: "Magnitude (mg)"
      strict: false
      downsample: '1S' # Resample to 1-second frequency for visualization

  # Create a grid layout with multiple signal types including sleep stage
  - type: time_series
    signals: ["hr", "accel_magnitude", "accel_angle", "sleep_stage"] # Added sleep_stage
    layout: grid
    title: "Multivariate Signal Dashboard (with Sleep Stage)"
    output: "results/visualizations/multivariate_dashboard.html"
    backend: plotly
    parameters:
      # width: 3000 
      # height: 600
      link_x_axes: true  # Synchronize x-axes for time alignment
      strict: false
      
  # Create a comprehensive plot with all signals (including sleep stage) in separate subplots
  - type: time_series
    signals: ["hr", "accel_magnitude", "accel_angle", "sleep_stage"] # Added sleep_stage
    layout: vertical
    title: "All Signals Overview (with Sleep Stage) - Linked X-Axes"
    output: "results/visualizations/all_signals_overview.html"
    backend: plotly
    parameters:
      link_x_axes: true  # Ensure x-axes are linked across all subplots
      downsample: 20000 # Limit each subplot to max 20,000 points for performance
      # width: 1200
      # height: 1800  # Taller to accommodate all subplots
      strict: false

  # New plot: Sleep Stages with HR and Accelerometer Magnitude
  - type: time_series
    signals: ["hr_0", "accel_magnitude", "sleep_stage_0"] # Use specific indexed signals (accel_magnitude might not have index if only one source)
    layout: vertical
    title: "Sleep Stages with Heart Rate and Activity (Example)"
    output: "results/visualizations/sleep_stage_dashboard.html"
    backend: bokeh # Or bokeh
    parameters:
      link_x_axes: true
      strict: false # Be lenient if index 0 doesn't exist for all
      # Optional: Define custom colors for sleep stages if needed
      # category_map: 
      #   Awake: 'rgb(150, 150, 150)'
      #   N1: 'rgb(173, 216, 230)'
      #   N2: 'rgb(0, 0, 255)'
      #   N3: 'rgb(0, 0, 139)'
      #   REM: 'rgb(128, 0, 128)'
